#include <stdio.h>
#include <stdint.h>
#include <assert.h>
#include <time.h>
#include <iostream>
#include <fstream>
#include <iomanip>
using namespace std;

// CUDA runtime
#include <cuda_runtime.h>
// helper functions and utilities to work with CUDA
#include <device_launch_parameters.h>


typedef unsigned char u8;
typedef unsigned int u32;
typedef unsigned long long u64;


#define N 40
#define count 1099511627776
#define r 126
#define THREAD_NUM 256
#define BLOCK_NUM 2048


__device__ u8 Grain_v1(u8* list, u8* K, u64 loc)
{
    u8 s1[80] = { 0 };
    u8 s2[80] = { 0 };
    u8 b1[80] = { 0 };
    u8 b2[80] = { 0 };
    u32 i, j;

    for (i = 0; i < 80; i++)              //给自由IV赋值 
    {
        b1[i] = K[i];
        b2[i] = K[i];
    }
    for (i = 0; i < N; i++)              //给自由IV赋值 
        s1[list[i]] = (loc >> i) & 1;
    for (i = 64; i < 80; i++)
        s1[i] = 1;


    s1[25] = 0;
    s1[53] = 0;
    s1[63] = 0;
    s1[26] = 0;
    s1[4] = 1;
    s1[31] = 1;
    s1[59] = 0;
    s1[62] = 0;
    s1[6] = K[6] ^ K[7] ^ K[8] ^ K[10] ^ K[15] * K[21] * K[27] * K[34] * K[39] ^ K[15] * K[21] ^ K[15] * K[34] * K[51] * K[69] ^ K[15] ^ K[16] ^ K[20] ^ K[21] * K[27] * K[66] * K[69] ^ K[27] * K[34] * K[39] * K[43] * K[51] * K[58] ^ K[27] * K[34] * K[39] ^ K[27] ^ K[34] ^ K[37] ^ K[39] * K[43] * K[58] * K[66] ^ K[39] * K[43] ^ K[39] ^ K[43] * K[51] * K[58] * K[66] * K[69] ^ K[43] ^ K[49] ^ K[51] * K[58] * K[66] ^ K[51] ^ K[58] ^ K[62] ^ K[66] * K[69] ^ K[66] ^ K[68] ^ K[69] * s1[9] * s1[52] ^ s1[9] ^ s1[52] ^ 1;
    s1[3] = K[3] ^ K[4] ^ K[5] ^ K[7] ^ K[12] * K[18] * K[24] * K[31] * K[36] ^ K[12] * K[18] ^ K[12] * K[31] * K[48] * K[66] ^ K[12] ^ K[13] ^ K[17] ^ K[18] * K[24] * K[63] * K[66] ^ K[24] * K[31] * K[36] * K[40] * K[48] * K[55] ^ K[24] * K[31] * K[36] ^ K[24] ^ K[31] ^ K[34] ^ K[36] * K[40] * K[55] * K[63] ^ K[36] * K[40] ^ K[36] ^ K[40] * K[48] * K[55] * K[63] * K[66] ^ K[40] ^ K[46] ^ K[48] * K[55] * K[63] ^ K[48] ^ K[55] ^ K[59] ^ K[63] * K[66] ^ K[63] ^ K[65] ^ K[66] * s1[6] * s1[49] ^ K[66] * s1[28] * s1[49] ^ K[66] * s1[49] ^ s1[6] * s1[28] * s1[49] ^ s1[6] * s1[49] ^ s1[6] ^ s1[28] ^ s1[49];
    s1[5] = K[5] ^ K[6] ^ K[7] ^ K[9] ^ K[14] * K[20] * K[26] * K[33] * K[38] ^ K[14] * K[20] ^ K[14] * K[33] * K[50] * K[68] ^ K[14] ^ K[15] ^ K[19] ^ K[20] * K[26] * K[65] * K[68] ^ K[26] * K[33] * K[38] * K[42] * K[50] * K[57] ^ K[26] * K[33] * K[38] ^ K[26] ^ K[33] ^ K[36] ^ K[38] * K[42] * K[57] * K[65] ^ K[38] * K[42] ^ K[38] ^ K[42] * K[50] * K[57] * K[65] * K[68] ^ K[42] ^ K[48] ^ K[50] * K[57] * K[65] ^ K[50] ^ K[57] ^ K[61] ^ K[65] * K[68] ^ K[65] ^ K[67] ^ K[68] * s1[8] * s1[51] ^ K[68] * s1[30] * s1[51] ^ K[68] * s1[51] ^ s1[8] * s1[30] * s1[51] ^ s1[8] * s1[51] ^ s1[8] ^ s1[30] ^ s1[51];
    s1[41] = K[4] ^ K[5] ^ K[6] ^ K[8] ^ K[13] * K[19] * K[25] * K[32] * K[37] ^ K[13] * K[19] ^ K[13] * K[32] * K[49] * K[67] ^ K[16] ^ K[18] ^ K[19] * K[25] * K[64] * K[67] ^ K[22] ^ K[25] * K[32] * K[37] * K[41] * K[49] * K[56] ^ K[25] * K[32] * K[37] ^ K[25] ^ K[29] ^ K[30] ^ K[35] ^ K[37] * K[41] * K[56] * K[64] ^ K[37] * K[41] ^ K[37] ^ K[38] ^ K[41] * K[49] * K[56] * K[64] * K[67] ^ K[41] ^ K[43] ^ K[47] ^ K[49] * K[56] * K[64] ^ K[49] ^ K[55] ^ K[56] ^ K[59] ^ K[60] ^ K[64] * K[67] ^ K[64] ^ K[66] ^ K[67] * s1[7] * s1[50] ^ K[67] * s1[29] * s1[50] ^ K[67] * s1[50] ^ K[68] ^ K[71] ^ K[75] * s1[15] * s1[58] ^ K[75] * s1[37] * s1[58] ^ K[75] * s1[58] ^ s1[7] * s1[29] * s1[50] ^ s1[7] * s1[50] ^ s1[7] ^ s1[12] ^ s1[15] * s1[37] * s1[58] ^ s1[15] * s1[58] ^ s1[15] ^ s1[28] ^ s1[29] ^ s1[35] ^ s1[37] ^ s1[51] ^ s1[58];
    s1[44] = K[2] ^ K[3] ^ K[4] ^ K[6] ^ K[11] * K[17] * K[23] * K[30] * K[35] ^ K[11] * K[17] ^ K[11] * K[30] * K[47] * K[65] ^ K[11] ^ K[12] ^ K[16] ^ K[17] * K[23] * K[62] * K[65] ^ K[23] * K[30] * K[35] * K[39] * K[47] * K[54] ^ K[23] * K[30] * K[35] ^ K[23] ^ K[30] ^ K[33] ^ K[35] * K[39] * K[54] * K[62] ^ K[35] * K[39] ^ K[35] ^ K[39] * K[47] * K[54] * K[62] * K[65] ^ K[39] ^ K[45] ^ K[47] * K[54] * K[62] ^ K[47] ^ K[54] ^ K[58] ^ K[62] * K[65] ^ K[62] ^ K[64] ^ K[65] * s1[5] * s1[48] ^ K[65] * s1[27] * s1[48] ^ K[65] * s1[48] ^ s1[2] ^ s1[5] * s1[27] * s1[48] ^ s1[5] * s1[48] ^ s1[5] ^ s1[27] ^ s1[48];
    s1[16] = K[16] ^ K[17] ^ K[18] ^ K[20] ^ K[25] * K[31] * K[37] * K[44] * K[49] ^ K[25] * K[31] ^ K[25] * K[44] * K[61] * K[79] ^ K[25] ^ K[26] ^ K[30] ^ K[31] * K[37] * K[76] * K[79] ^ K[37] * K[44] * K[49] * K[53] * K[61] * K[68] ^ K[37] * K[44] * K[49] ^ K[37] ^ K[44] ^ K[47] ^ K[49] * K[53] * K[68] * K[76] ^ K[49] * K[53] ^ K[49] ^ K[53] * K[61] * K[68] * K[76] * K[79] ^ K[53] ^ K[59] ^ K[61] * K[68] * K[76] ^ K[61] ^ K[68] ^ K[72] ^ K[76] * K[79] ^ K[76] ^ K[78] ^ K[79] ^ s1[41];
    s1[38] = K[13] ^ K[14] ^ K[15] ^ K[17] ^ K[22] * K[28] * K[34] * K[41] * K[46] ^ K[22] * K[28] ^ K[22] * K[41] * K[58] * K[76] ^ K[22] ^ K[23] ^ K[27] ^ K[28] * K[34] * K[73] * K[76] ^ K[34] * K[41] * K[46] * K[50] * K[58] * K[65] ^ K[34] * K[41] * K[46] ^ K[34] ^ K[41] ^ K[44] ^ K[46] * K[50] * K[65] * K[73] ^ K[46] * K[50] ^ K[46] ^ K[50] * K[58] * K[65] * K[73] * K[76] ^ K[50] ^ K[56] ^ K[58] * K[65] * K[73] ^ K[58] ^ K[65] ^ K[69] ^ K[73] * K[76] ^ K[73] ^ K[75] ^ s1[13] ^ s1[16];
    s1[23] = K[1] ^ K[2] ^ K[4] ^ K[10] ^ K[31] ^ K[43] ^ K[56] ^ K[63] * s1[3] * s1[46] ^ K[63] * s1[46] ^ s1[0] ^ s1[3] * s1[46] ^ s1[3] ^ s1[13] ^ s1[38] ^ s1[46] ^ s1[51];
    s1[24] = K[2] ^ K[3] ^ K[5] ^ K[11] ^ K[32] ^ K[44] ^ K[57] ^ s1[1] ^ s1[14] ^ s1[39] ^ s1[52];
    s1[54] = K[17] ^ K[18] ^ K[20] ^ K[26] ^ K[47] ^ K[59] ^ K[72] ^ K[79] ^ s1[16] ^ s1[29] ^ s1[39] ^ s1[41];
    s1[57] = K[7] ^ K[8] ^ K[10] ^ K[16] ^ K[37] ^ K[49] ^ K[62] ^ K[69] * s1[9] * s1[52] ^ s1[6] ^ s1[9] ^ s1[19] ^ s1[29] ^ s1[44] ^ s1[52];
    s1[10] = K[11] ^ K[12] ^ K[14] ^ K[20] ^ K[41] ^ K[53] ^ K[66] ^ K[73] * s1[13] * s1[56] ^ K[73] * s1[35] * s1[56] ^ K[73] * s1[56] ^ s1[13] * s1[35] * s1[56] ^ s1[13] * s1[56] ^ s1[13] ^ s1[23] ^ s1[33] ^ s1[35] ^ s1[48] ^ s1[56] ^ s1[61] ^ 1;
    s1[45] = K[8] ^ K[9] ^ K[11] ^ K[17] ^ K[23] ^ K[24] ^ K[25] ^ K[27] ^ K[32] * K[38] * K[44] * K[51] * K[56] ^ K[32] * K[38] ^ K[32] ^ K[33] ^ K[37] ^ K[38] ^ K[44] * K[51] * K[56] * K[60] * K[68] * K[75] ^ K[44] * K[51] * K[56] ^ K[44] ^ K[50] ^ K[51] ^ K[54] ^ K[56] * K[60] ^ K[56] ^ K[60] ^ K[63] ^ K[66] ^ K[68] ^ K[75] ^ K[79] ^ s1[7] ^ s1[10] ^ s1[20] ^ s1[23] ^ s1[30] ^ s1[32] ^ s1[43] ^ s1[48] ^ s1[58] ^ 1;
    s1[42] = K[9] ^ K[10] ^ K[11] ^ K[13] ^ K[15] ^ K[16] ^ K[17] ^ K[18] * K[24] * K[30] * K[37] * K[42] ^ K[18] * K[24] ^ K[18] * K[37] * K[54] * K[72] ^ K[19] ^ K[21] ^ K[23] ^ K[24] * K[30] * K[36] * K[43] * K[48] ^ K[24] * K[30] * K[69] * K[72] ^ K[24] * K[30] ^ K[24] * K[43] * K[60] * K[78] ^ K[24] ^ K[25] ^ K[27] ^ K[29] ^ K[30] * K[36] * K[75] * K[78] ^ K[30] * K[37] * K[42] * K[46] * K[54] * K[61] ^ K[30] * K[37] * K[42] ^ K[30] ^ K[33] ^ K[34] ^ K[35] ^ K[36] * K[43] * K[48] * K[52] * K[60] * K[67] ^ K[36] * K[43] * K[48] ^ K[36] ^ K[40] ^ K[42] * K[46] * K[61] * K[69] ^ K[42] * K[46] ^ K[42] * K[48] * K[54] * K[61] * K[66] ^ K[42] * K[48] ^ K[46] * K[54] * K[61] * K[69] * K[72] ^ K[47] ^ K[48] * K[52] * K[67] * K[75] ^ K[48] * K[52] ^ K[52] * K[60] * K[67] * K[75] * K[78] ^ K[54] * K[61] * K[66] ^ K[54] * K[61] * K[69] ^ K[58] ^ K[60] * K[67] * K[75] ^ K[64] ^ K[65] ^ K[66] * K[70] ^ K[66] ^ K[67] ^ K[69] * K[72] ^ K[69] ^ K[70] ^ K[72] * s1[12] * s1[55] ^ K[72] * s1[34] * s1[55] ^ K[72] * s1[55] ^ K[73] ^ K[75] * K[78] ^ K[75] ^ K[76] ^ K[77] ^ K[78] * s1[18] * s1[61] ^ K[78] * s1[40] * s1[61] ^ K[78] * s1[61] ^ K[78] ^ s1[9] ^ s1[12] * s1[34] * s1[55] ^ s1[12] * s1[55] ^ s1[12] ^ s1[15] ^ s1[17] ^ s1[18] * s1[40] * s1[61] ^ s1[18] * s1[61] ^ s1[18] ^ s1[20] ^ s1[30] ^ s1[33] ^ s1[34] ^ s1[36] * s1[58] ^ s1[58] ^ s1[61];

   for (i = 0; i < 80; i++)
        s2[i] = s1[i];
    s2[22] = s1[22]^1;
    s2[47] = s1[47]^1;

    u8 t1, t2, z1, z2;

    for (i = 0; i < r; i++)            
    {
        t1 = s1[62] ^ s1[51] ^ s1[38] ^ s1[23] ^ s1[13] ^ s1[0];
        t2 = s1[0] ^ b1[62] ^ b1[60] ^ b1[52] ^ b1[45] ^ b1[37] ^ b1[33] ^ b1[28] ^ b1[21] ^ b1[14] ^ b1[9] ^ b1[0] ^ b1[63] & b1[60] ^ b1[37] & b1[33] ^ b1[15] & b1[9] ^ b1[60] & b1[52] & b1[45] ^ b1[33] & b1[28] & b1[21] ^ b1[63] & b1[45] & b1[28] & b1[9] ^ b1[60] & b1[52] & b1[37] & b1[33] ^ b1[63] & b1[60] & b1[21] & b1[15] ^ b1[63] & b1[60] & b1[52] & b1[45] & b1[37] ^ b1[33] & b1[28] & b1[21] & b1[15] & b1[9] ^ b1[52] & b1[45] & b1[37] & b1[33] & b1[28] & b1[21];
        z1 = b1[1] ^ b1[2] ^ b1[4] ^ b1[10] ^ b1[31] ^ b1[43] ^ b1[56] ^ s1[25] ^ b1[63] ^ s1[3] & s1[64] ^ s1[46] & s1[64] ^ s1[64] & b1[63] ^ s1[3] & s1[25] & s1[46] ^ s1[3] & s1[46] & s1[64] ^ s1[3] & s1[46] & b1[63] ^ s1[25] & s1[46] & b1[63] ^ s1[46] & s1[64] & b1[63];

        for (j = 0; j < 79; j++)
        {
            b1[j] = b1[j + 1];
            s1[j] = s1[j + 1];
        }
        s1[79] = t1 ^ z1;
        b1[79] = t2 ^ z1;
    }

    for (i = 0; i < r; i++)          
    {
        t1 = s2[62] ^ s2[51] ^ s2[38] ^ s2[23] ^ s2[13] ^ s2[0];
        t2 = s2[0] ^ b2[62] ^ b2[60] ^ b2[52] ^ b2[45] ^ b2[37] ^ b2[33] ^ b2[28] ^ b2[21] ^ b2[14] ^ b2[9] ^ b2[0] ^ b2[63] & b2[60] ^ b2[37] & b2[33] ^ b2[15] & b2[9] ^ b2[60] & b2[52] & b2[45] ^ b2[33] & b2[28] & b2[21] ^ b2[63] & b2[45] & b2[28] & b2[9] ^ b2[60] & b2[52] & b2[37] & b2[33] ^ b2[63] & b2[60] & b2[21] & b2[15] ^ b2[63] & b2[60] & b2[52] & b2[45] & b2[37] ^ b2[33] & b2[28] & b2[21] & b2[15] & b2[9] ^ b2[52] & b2[45] & b2[37] & b2[33] & b2[28] & b2[21];
        z2 = b2[1] ^ b2[2] ^ b2[4] ^ b2[10] ^ b2[31] ^ b2[43] ^ b2[56] ^ s2[25] ^ b2[63] ^ s2[3] & s2[64] ^ s2[46] & s2[64] ^ s2[64] & b2[63] ^ s2[3] & s2[25] & s2[46] ^ s2[3] & s2[46] & s2[64] ^ s2[3] & s2[46] & b2[63] ^ s2[25] & s2[46] & b2[63] ^ s2[46] & s2[64] & b2[63];

        for (j = 0; j < 79; j++)
        {
            b2[j] = b2[j + 1];
            s2[j] = s2[j + 1];
        }
        s2[79] = t1 ^ z2;
        b2[79] = t2 ^ z2;
    }

    z1 = b1[1] ^ b1[2] ^ b1[4] ^ b1[10] ^ b1[31] ^ b1[43] ^ b1[56] ^ s1[25] ^ b1[63] ^ s1[3] & s1[64] ^ s1[46] & s1[64] ^ s1[64] & b1[63] ^ s1[3] & s1[25] & s1[46] ^ s1[3] & s1[46] & s1[64] ^ s1[3] & s1[46] & b1[63] ^ s1[25] & s1[46] & b1[63] ^ s1[46] & s1[64] & b1[63];
    z2 = b2[1] ^ b2[2] ^ b2[4] ^ b2[10] ^ b2[31] ^ b2[43] ^ b2[56] ^ s2[25] ^ b2[63] ^ s2[3] & s2[64] ^ s2[46] & s2[64] ^ s2[64] & b2[63] ^ s2[3] & s2[25] & s2[46] ^ s2[3] & s2[46] & s2[64] ^ s2[3] & s2[46] & b2[63] ^ s2[25] & s2[46] & b2[63] ^ s2[46] & s2[64] & b2[63];

    return z1 ^ z2;
}




__global__ void kernel(u64* gpu_truthtable, u8* gpu_list, u8* gpu_K)
{
    const u64 tidx = threadIdx.x;
    const u64 bid = blockIdx.x;
    u64 result = 0;
    for (u64 i = bid * THREAD_NUM + tidx; i < count; i = i + BLOCK_NUM * THREAD_NUM)
        result += Grain_v1(gpu_list, gpu_K, i);
    gpu_truthtable[bid * THREAD_NUM + tidx] = result;
}


u64 excute(u8* list, u8* K)
{
    u8* gpu_list;
    u8* gpu_K;
    u64* truthtable = (u64*)calloc(THREAD_NUM * BLOCK_NUM, sizeof(u64));
    u64* gpu_truthtable;

    cudaMalloc((void**)&gpu_truthtable, THREAD_NUM * BLOCK_NUM * sizeof(u64));
    cudaMalloc((void**)&gpu_list, N * sizeof(u8));
    cudaMalloc((void**)&gpu_K, 80 * sizeof(u8));

    cudaMemcpy(gpu_list, list, N * sizeof(u8), cudaMemcpyHostToDevice);
    cudaMemcpy(gpu_K, K, 80 * sizeof(u8), cudaMemcpyHostToDevice);

    kernel << <BLOCK_NUM, THREAD_NUM >> > (gpu_truthtable, gpu_list, gpu_K);
    cudaError err = cudaGetLastError();
    if (err != cudaSuccess)
    {
        printf("CUDA Error: %s\n", cudaGetErrorString(err));
    }
    cudaMemcpy(truthtable, gpu_truthtable, THREAD_NUM * BLOCK_NUM * sizeof(u64), cudaMemcpyDeviceToHost);

    u64 result = 0;
    for (u32 i = 0; i < THREAD_NUM * BLOCK_NUM; i++)
        result = result + truthtable[i];

    free(truthtable);
    cudaFree(gpu_truthtable);
    cudaFree(gpu_list);
    cudaFree(gpu_K);
    cudaDeviceReset();
    return result;
}





int main()
{
    ofstream results;
    results.open("results-126round.txt", ios_base::app);

    for (int loc = 0; loc < 1000; loc++)
    {
        cout << loc + 1 << endl;

        u8 list[N] = { 0,1,2,7,8,9,11,12,13,14,15,17,18,19,20,21,27,28,29,30,32,33,34,35,36,37,39,40,43,46,48,49,50,51,52,55,56,58,60,61 };
        u8 K[80] = { 0 };

        srand((unsigned)time(NULL));
        for (int i = 0; i < 80; i++)
        {
            K[i] = rand() % 2;
            results << (int)K[i] << ",";
        }
        results << endl;
        u64 sum = excute(list, K);

        cout << "sum = " << (unsigned long long)sum << endl;
        results << "sum = " << (unsigned long long)sum << endl;
    }
    results.close();

    return 0;
}


